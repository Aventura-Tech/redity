"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=_default;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_symbols=require("./utils/symbols"),_exceptions=_interopRequireDefault(require("./utils/exceptions")),_access=require("./utils/access"),_states=_interopRequireDefault(require("./states")),_dispatcher=_interopRequireDefault(require("./dispatcher")),_blockcode=_interopRequireDefault(require("./blockcode")),_subscriber=_interopRequireDefault(require("./subscriber")),_index=_interopRequireDefault(require("./index"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(b,!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(b).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var IsNotObject=_exceptions["default"].IsNotObject;function _default(){var a=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,c={access:_access.PRIVATE,dev:!0},d=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),e=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),f=function(){},g=new _states["default"],h=new _dispatcher["default"],i=new Map;Object.defineProperty(this,"access",{get:function get(){return c.access},set:function set(a){c.access=a},configurable:!1,enumerable:!0}),Object.defineProperty(this,"key",{value:b,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"states",{get:function get(){return g.toMethod()},enumerable:!0,configurable:!1}),this.statesValues=function(){return g.values()},Object.defineProperty(this,"dispatchers",{get:function get(){return h.toMethod()},enumerable:!0,configurable:!1}),Object.defineProperty(this,"init",{set:function set(a){f=a},enumerable:!0,configurable:!1}),Object.defineProperty(this,"onListen",{set:function set(a){d=a},enumerable:!0,configurable:!1}),Object.defineProperty(this,"onFail",{set:function set(a){e=a},enumerable:!0,configurable:!1}),this.capsule=[];var j={states:{},dispatchers:{}},k={states:{},dispatchers:{},dev:!0,access:_access.PRIVATE},l=function(){if("object"!==(0,_typeof2["default"])(j.states)||Array.isArray(j.states))throw IsNotObject("initial");if("object"!==(0,_typeof2["default"])(k.states)||Array.isArray(k.states))throw IsNotObject("initial");if("object"!==(0,_typeof2["default"])(j.dispatchers)||Array.isArray(j.dispatchers))throw IsNotObject("initial");if("object"!==(0,_typeof2["default"])(k.dispatchers)||Array.isArray(k.dispatchers))throw IsNotObject("initial");g.init(j.states,k.states),h.init(j.dispatchers,k.dispatchers),c.dev=k.dev,c.access=k.access};this[_symbols.symModelCreate]=function(){var b=!(0<arguments.length&&arguments[0]!==void 0)||arguments[0];f(j,k),l();var m=!!b&&c.dev;g.onListen=function(a,b){var c=!0,d=!1,e=void 0;try{for(var f,h,j=i.entries()[Symbol.iterator]();!(c=(f=j.next()).done);c=!0)h=f.value,h[1][_symbols.symSubscriberGenerate](a,b,g.values())}catch(a){d=!0,e=a}finally{try{c||null==j["return"]||j["return"]()}finally{if(d)throw e}}},h.onListen=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(c,f,j){var k,l,n,o,p,q,r,s,t,u;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:for(k={},l=!0,n=!1,o=void 0,b.prev=4,p=i.entries()[Symbol.iterator]();!(l=(q=p.next()).done);l=!0)r=(0,_slicedToArray2["default"])(q.value,2),s=r[0],t=r[1],k[s]={props:t.props,hide:function hide(){},unhide:function unhide(){},replace:function replace(){}};b.next=12;break;case 8:b.prev=8,b.t0=b["catch"](4),n=!0,o=b.t0;case 12:b.prev=12,b.prev=13,l||null==p["return"]||p["return"]();case 15:if(b.prev=15,!n){b.next=18;break}throw o;case 18:return b.finish(15);case 19:return b.finish(12);case 20:return u={key:a.key,dispatchers:h.toMethod(),payload:c,action:f.key,actions:j,models:_objectSpread({},_index["default"].model["public"](a.key),{},_index["default"].model["protected"](a.key)),history:{},components:Object.freeze(k),blockcode:new _blockcode["default"](m)},u.resolve=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return u.blockcode["catch"](b),a.next=3,e(b,g.toMethod(),u);case 3:return c=a.sent,a.abrupt("return",c);case 5:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Object.freeze(u),u.blockcode.start("Dispatch: ".concat(f.key),c),b.abrupt("return",new Promise(function(a){d(c,g.toMethod(),u).then(function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(c){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:u.blockcode.end(),f.done(),a(c);case 3:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())["catch"](function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(c){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return u.blockcode["catch"](c),b.next=3,e(c,g.toMethod(),u);case 3:u.blockcode.end(),f.done(),a(!0);case 6:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())}));case 25:case"end":return b.stop();}},b,null,[[4,8,12,20],[13,,15,19]])}));return function(){return b.apply(this,arguments)}}()},this.subscribe=function(a){if(!(a instanceof _subscriber["default"]))throw new Error("Require a instance of Subscriber");return a[_symbols.symSubscriberInit](g.values()),i.set(a.key,a),a.key},this.deleteSubscribe=function(a){i["delete"](a)}}