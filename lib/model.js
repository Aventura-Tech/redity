"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=_default;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_symbols=require("./utils/symbols"),_exceptions=_interopRequireDefault(require("./utils/exceptions")),_states=_interopRequireDefault(require("./states")),_dispatcher=_interopRequireDefault(require("./dispatcher")),_blockcode=_interopRequireDefault(require("./blockcode")),_subscriber=_interopRequireDefault(require("./subscriber")),_index=_interopRequireDefault(require("./index"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(b,!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(b).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var IsNotObject=_exceptions["default"].IsNotObject;function _default(a){var b=this;this.key=a,this.config={dev:!0,publicStates:!1,publicDispatchers:!1};var c=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),d=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),e=function(){},f=new _states["default"],g=new _dispatcher["default"],h=new Map;Object.defineProperty(this,"states",{get:function get(){return f.toMethod()},enumerable:!0,configurable:!1}),this.statesValues=function(){return f.values()},Object.defineProperty(this,"dispatchers",{get:function get(){return g.toMethod()},enumerable:!0,configurable:!1}),Object.defineProperty(this,"init",{set:function set(a){e=a},enumerable:!0,configurable:!1}),Object.defineProperty(this,"onListen",{set:function set(a){c=a},enumerable:!0,configurable:!1}),Object.defineProperty(this,"onFail",{set:function set(a){d=a},enumerable:!0,configurable:!1}),this.capsule=[];var i={states:{},dispatchers:{}},j={states:{},dispatchers:{},dev:!0,publicStates:!1,publicDispatchers:!1},k=function(){if("object"!==(0,_typeof2["default"])(i.states)||Array.isArray(i.states))throw IsNotObject("initial");if("object"!==(0,_typeof2["default"])(j.states)||Array.isArray(j.states))throw IsNotObject("initial");if("object"!==(0,_typeof2["default"])(i.dispatchers)||Array.isArray(i.dispatchers))throw IsNotObject("initial");if("object"!==(0,_typeof2["default"])(j.dispatchers)||Array.isArray(j.dispatchers))throw IsNotObject("initial");f.init(i.states,j.states),g.init(i.dispatchers,j.dispatchers),b.config=_objectSpread({},j)};this[_symbols.symModelCreate]=function(){var a=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];e(i,j),k();var l=!!a&&b.config.dev;for(var m in f.onListen=function(a,b){var c=!0,d=!1,e=void 0;try{for(var g,i,j=h.entries()[Symbol.iterator]();!(c=(g=j.next()).done);c=!0)i=g.value,i[1][_symbols.symSubscriberGenerate](a,b,f.values(),f.toMethod())}catch(a){d=!0,e=a}finally{try{c||null==j["return"]||j["return"]()}finally{if(d)throw e}}},g.onListen=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(e,i,j){var k,m,n,o,p,q,r,s,t,u,v,w,x;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:for(k={},m=!0,n=!1,o=void 0,a.prev=4,p=h.entries()[Symbol.iterator]();!(m=(q=p.next()).done);m=!0)r=(0,_slicedToArray2["default"])(q.value,2),s=r[0],t=r[1],k[s]={props:t.props,hide:function hide(){},unhide:function unhide(){},replace:function replace(){}};a.next=12;break;case 8:a.prev=8,a.t0=a["catch"](4),n=!0,o=a.t0;case 12:a.prev=12,a.prev=13,m||null==p["return"]||p["return"]();case 15:if(a.prev=15,!n){a.next=18;break}throw o;case 18:return a.finish(15);case 19:return a.finish(12);case 20:for(w in u=_index["default"].model.all(b.key),v={},u)v[w]={},u[w].config.publicStates&&(v[w].states=u[w].states),u[w].config.publicDispatchers&&(v[w].dispatchers=u[w].dispatchers);return x={key:b.key,dispatchers:g.toMethod(),payload:e,action:i.key,actions:j,models:v,history:{},components:Object.freeze(k),blockcode:new _blockcode["default"](l)},x.resolve=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return x.blockcode["catch"](b),a.next=3,d(b,f.toMethod(),x);case 3:return c=a.sent,a.abrupt("return",c);case 5:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Object.freeze(x),x.blockcode.start("Dispatch: ".concat(i.key),e),a.abrupt("return",new Promise(function(a){c(e,f.toMethod(),x).then(function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(c){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:x.blockcode.end(),i.done(),a(c);case 3:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())["catch"](function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(c){var e;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return x.blockcode["catch"](c),b.next=3,d(c,f.toMethod(),x);case 3:e=b.sent,x.blockcode.end(),i.done(),a(e);case 7:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())}));case 28:case"end":return a.stop();}},a,null,[[4,8,12,20],[13,,15,19]])}));return function(){return a.apply(this,arguments)}}(),j.dispatchers)if(j.dispatchers[m].now){var n=g.get(m);n.dispatch(n.defaultValue)}},this.subscribe=function(a){if(!(a instanceof _subscriber["default"]))throw new Error("Require a instance of Subscriber");return a[_symbols.symSubscriberInit](f.values(),f.toMethod()),h.set(a.key,a),a.key},this.deleteSubscribe=function(a){h["delete"](a)},this.disableDispatch=g.disable,this.enableDispatch=g.enable}